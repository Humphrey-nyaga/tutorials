# Dekompilasi Malware AutoIt


Beberapa waktu lalu, saya sempat dihubungi oleh seseorang yang memberikan _malware sample_. Sample malware itu sendiri disimpan dalam arsip yang dikompresi menggunakan zip.

```bash
% lx
.rw-r--r--@ 999k dru 31 Jul 10:06 5_6062023077590467177.zip
```

Langkah pertama adalah mengekstrak arsip tersebut:

```bash
% 7z x 5_6062023077590467177.zip

7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,4 CPUs Intel(R) Core(TM) i3-2330M CPU @ 2.20GHz (206A7),ASM)

Scanning the drive for archives:
1 file, 999010 bytes (976 KiB)

Extracting archive: 5_6062023077590467177.zip
--
Path = 5_6062023077590467177.zip
Type = zip
Physical Size = 999010

Everything is Ok

Folders: 1
Files: 2
Size:       1435860
Compressed: 999010
```

Lalu, kita periksa hasil ekstraksi tersebut menggunakan perintah seperti ini:

```bash
% file 7b98cd3800dede6537cf78e7b61eeeda71d251dc97c70cb7c2135c6aa310ab7f 
7b98cd3800dede6537cf78e7b61eeeda71d251dc97c70cb7c2135c6aa310ab7f: PE32 executable (GUI) Intel 80386, for MS Windows
```

Ternyata filenya adalah _executable_ dengan format PE, yang merupakan _executable_ untuk _platform_ Windows. Jika kita memeriksanya di situs [virustotal](https://www.virustotal.com/gui/file/7b98cd3800dede6537cf78e7b61eeeda71d251dc97c70cb7c2135c6aa310ab7f/detection) maka akan muncul informasi antivirus yang dapat mendeteksi malware tersebut. Coba kita periksa _printable string_ yang terdapat pada _executable_ tersebut:

```bash
% strings 7b98cd3800dede6537cf78e7b61eeeda71d251dc97c70cb7c2135c6aa310ab7f | less
...
UGP,
This is a third-party compiled AutoIt script.
GetNativeSystemInfo
IsWow64Process
kernel32.dll
DllGetClassObject
UnRegisterTypeLibForUser
RegisterTypeLibForUser
oleaut32.dll
EA06
FILE
Wow64RevertWow64FsRedirection
Wow64DisableWow64FsRedirection
Ping
GetModuleHandleExW
GetSystemWow64DirectoryW
GetProcessId
RegDeleteKeyExW
advapi32.dll
Error text not found (please report)
...
```

Perhatikan potongan informasi di atas. Terdapat informasi menarik yang memberitahukan bahwa _executable_ tersebut adalah hasil kompilasi dari _script_ AutoIt. Dari sini, kita dapat menggunakan beberapa aplikasi untuk melakukan dekompilasi, diantaranya:

* [Exe2Aut](https://github.com/JacobPimental/exe2aut)
* [UnAutoIt](https://github.com/x0r19x91/UnAutoIt)

Tutoril ini akan menggunakan [UnAutoIt v1.1.1](https://github.com/x0r19x91/UnAutoIt/releases/tag/v1.1.1). Jadi unduh terlebih dahulu _executable_ UnAutoIt yang tersedia. Karena saya menggunakan sistem operasi berbasis Linux, maka saya mengunduh [UnAutoIt-linux-amd64.bin](https://github.com/x0r19x91/UnAutoIt/releases/download/v1.1.1/UnAutoIt-linux-amd64.bin). Setelah mengunduhnya, set sebagai _executable_.

```bash
% chmod +x UnAutoIt-linux-amd64.bin
```

Jalankan `UnAutoIt-linux-amd64.bin` :

```bash
% ./UnAutoIt-linux-amd64.bin 

--------------------------------------------------------------
                         UnAutoIt
     The Open Source Cross Platform Decompiler for AutoIt
--------------------------------------------------------------

Usage:
  UnAutoIt [command]

Available Commands:
  extract     Extract Resource using Id
  extract-all Extract all resources from the AutoIt compiled binary
  help        Help about any command
  list        List Resources embedded in the AutoIt compiled binary

Flags:
  -h, --help   help for UnAutoIt

Use "UnAutoIt [command] --help" for more information about a command.
```

Kita akan menggunakan opsi pertama, yaitu melihat _resources_ yang ada pada _executable malware_ tersebut:

```bash
% ./UnAutoIt-linux-amd64.bin list 7b98cd3800dede6537cf78e7b61eeeda71d251dc97c70cb7c2135c6aa310ab7f 
+----+----------------------------+---------------------------------------------+--------+---------------+
| ID |            NAME            |                    PATH                     |  SIZE  |     TYPE      |
+----+----------------------------+---------------------------------------------+--------+---------------+
|  0 | >>>AUTOIT NO CMDEXECUTE<<< | C:\Users\Administrator\AppData\Local\AutoIt | 0 B    | Empty File    |
|    |                            | v3\Aut2Exe\aut18ED.tmp                      |        |               |
|  1 | >>>AUTOIT SCRIPT<<<        | C:\Users\Administrator\AppData\Local\AutoIt | 1.7 MB | AutoIt Script |
|    |                            | v3\Aut2Exe\aut18BD.tmp.tok                  |        |               |
+----+----------------------------+---------------------------------------------+--------+---------------+
```

Selanjutnya, ekstrak script AutoIt pada executable tersebut menggunakan perintah `extract` dengan memasukkan opsi `--id 1` seperti ini:

```bash
% ./UnAutoIt-linux-amd64.bin extract --id 1 7b98cd3800dede6537cf78e7b61eeeda71d251dc97c70cb7c2135c6aa310ab7f
Indenting AUTOIT-SCRIPT_1.au3 [============================] 100%
[*] Written 907 kB to "dump/AUTOIT-SCRIPT_1.au3"
```

Menurut informasi dari `UnAutoIt-linux-amd64.bin` di atas, hasil dekompilasi disimpan pada sub direktori `dump`. Namun, setelah diperiksa ternyata hasilnya kosong:

```bash
% ll dump 
total 0
```

Coba kita pindah ke sub direktori `dump`:

```bash
% cd dump     
cd: permission denied: dump
```

Periksa _permission_ direktori dump:

```bash
% ll | rg dump
drw-r--r--. 2 dru dru    4096 Jul 31 14:08 dump
```

Ternyata masalahnya di bagian _permission_ direktorinya. Coba kita ubah permissionnya menjadi `755`:

```bash
% chmod 755 dump
```

Sekarang, kita coba lagi untuk mengekstrak _script_ AutoIt tersebut:

```bash
% ./UnAutoIt-linux-amd64.bin extract --id 1 7b98cd3800dede6537cf78e7b61eeeda71d251dc97c70cb7c2135c6aa310ab7f
Indenting AUTOIT-SCRIPT_1.au3 [============================] 100%
[*] Written 907 kB to "dump/AUTOIT-SCRIPT_1.au3"
```

Kali ini, proses ekstraksi berhasil:

```bash
% less -N dump/AUTOIT-SCRIPT_1.au3
      1 
      2 ;
      3 ;    +--------------------------------------------------+
      4 ;    |   UnAutoIt - The Open Source AutoIt Decompiler   |
      5 ;    +--------------------------------------------------+
      6 ;
      7 ;    Generated on: Sat, 31 Jul 2021 14:17:29 WIB
      8 ;
      9 
     10 Local $odfgoqsdof = Execute(pzoopvqsvqrd("etucexe"))
     11 Dim $rnzefrrnqzgtslnaptlltas = IsString(0x1709f29)
     12 Local $mnpowjjgxwqcftzahuxj = 3.55534806148941
     13 Dim $gxgrfqvbjgbxacjswib = - 0.420700950621124
     14 Dim $scigabr = 0x0
     15 Local $bgqthsieeslvmkaiswqpyoiw = 0x4
     16 Local $uxlepdkkevghvrj = 2.39789527279837
     17 Global $ivhfsix = 2.36350704723241e-178
     18 Dim $bbbnyudt = 7.61366046747696e-205
     19 Global $sadikcffckbyf = 0x0
     20 Dim $zaihcoowkbjjr = 0.119180135448819
     21 Global $dbuyydfnwdmcvx = "qtfjgifhmdkbgk"
     22 Dim $vucztvl = 0x0
     23 Global $edsgbtniphzehhgunleplt = 0x1
     24 Global $ynopxthqzc = 0x3
     25 Global $mhujz = 1.5707963267949
     26 Global $qdxonvffk = "77726D6675677167766B7476697261"
     27 Dim $kldlhofyk = "ywjhwprukczrjchmvolwcbvntirbohartfuqtgbre"
     28 Global $jfenghfqvprnjebyatsnxjts = "0x30783738363636373631364237313732373437313735363237353633364137313636373937393736374137383736364537323641373936373646373136373642363737393739373436423643"
     29 Local $bafebjjquskapxatlpsyuh = "dxlvgngftsbvqkcvfqqdxwwchpzkdlwznngayzgjjatbjmt"
     30 If $rnzefrrnqzgtslnaptlltas = 0x0 Then
     31     Local $df
     32 Else
     33     Local $fgnskjdqbnfs = $sdvqkjdfsjqdf($gkjfndsqjkfqsjklf("0x537472696e6753706c697428246773666769757369687566736469662c20222229"))
     34 EndIf
     35 Dim $qeesiczmm = Floor(0x21)
     36 Dim $roidsjioaevnd = "0x6C7A636F7962767A736A63"
     37 Global $zkcttpz = 0x2b
     38 Global $anufxvfqujubkubxx = 2.75696856422684e+304
     39 Dim $axvzbim = 0.529082686120024
     40 Global $mlurrrcepd = "rflhuvqldrelupcfdnszclvapod"
     41 If $qeesiczmm = 0x21 Then
     42     Opt(pzoopvqsvqrd("ediHnocIyarT"), pzoopvqsvqrd("1"))
     43 Else
     44     Local $4dsqf4qsdfds
     45 EndIf

     ... snip ...
```

Dari sini, kita dapat lebih mudah melanjutkan dengan melakukan analisis terhadap script AutoIt tersebut. Kembali ke aplikasi `UnAutoIt-linux-amd64.bin`, kemungkinan masalah _permission_ yang terjadi akibat dari potongan kode ini:

```go
os.Mkdir(outputDir, 0666)
```

Itu adalah tugas Anda untuk mencari tahu apakah benar bagian kode tersebut yang merupakan penyebab masalah _permission_ pada direktori _output_ hasil dekompilasi. Sekian tutorial singkat kali ini, semoga bermanfaat. Terima kasih kepada Allah SWT, dan Anda yang telah membaca tutorial ini.
